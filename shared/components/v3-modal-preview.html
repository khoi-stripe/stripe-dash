<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 Modal Preview - Static Steps</title>
    <link rel="stylesheet" href="../styles/variables.css">
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/modal.css">
    <style>
        body { 
            padding: 40px; 
            background: var(--neutral-25); 
            font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; 
        }
        .preview-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 20px; 
        }
        .preview-header { 
            margin-bottom: 32px; 
            text-align: center; 
        }
        .preview-header h1 { 
            font-size: 24px; 
            font-weight: 600; 
            color: #353a44; 
            margin: 0 0 8px 0; 
        }
        .preview-header p { 
            color: #596171; 
            margin: 0; 
        }
        .steps-container { 
            display: flex; 
            gap: 40px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }
        .step-wrapper { 
            flex: 0 0 auto; 
        }
        .step-wrapper.step-1 { 
            width: 640px; 
        }
        .step-wrapper.step-2 { 
            width: 940px; 
        }
        .step-wrapper.step-2 .modal-static { 
            height: 640px; 
            display: flex;
            flex-direction: column;
        }
        .step-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: #353a44; 
            margin-bottom: 16px; 
            text-align: center; 
        }
        .modal-static { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 32px rgba(0, 0, 0, 0.12); 
            overflow: hidden; 
        }
        .modal-header { 
            padding: 24px 24px 16px; 
        }
        .modal-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: #1a1a1a; 
            margin: 0; 
        }
        .modal-content { 
            padding: 24px; 
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .modal-footer { 
            padding: 16px 24px 24px; 
            display: flex; 
            justify-content: flex-end; 
            gap: 12px; 
        }
        .modal-button { 
            padding: 8px 16px; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            border: 1px solid; 
            height: 36px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-button-secondary { 
            background: white; 
            border-color: #d8dee4; 
            color: #596171; 
        }
        .modal-button-primary { 
            background: #675dff; 
            border-color: #675dff; 
            color: white; 
        }
        .modal-form-group { 
            margin-bottom: 20px; 
        }
        .modal-form-label { 
            display: block; 
            font-size: 14px; 
            font-weight: 600; 
            color: #353a44; 
            margin-bottom: 8px; 
        }
        .modal-form-input { 
            width: 100%; 
            padding: 8px 12px; 
            border: 1px solid #d8dee4; 
            border-radius: 6px; 
            font-size: 14px; 
            color: #353a44; 
            background: white; 
            box-sizing: border-box; 
        }
        textarea.modal-form-input { 
            resize: vertical; 
            min-height: 80px; 
        }
        
        /* Step 2 specific styles */
        .accounts-container { display: flex; gap: 32px; flex: 1; margin-top: 24px; min-height: 0; }
        .accounts-left { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .accounts-right { flex: 1; background: #f7f5fd; border-radius: 12px; padding: 16px; box-sizing: border-box; min-height: 0; overflow-y: auto; }
        .accounts-right {
            scrollbar-width: thin;
            scrollbar-color: var(--neutral-400) transparent;
        }
        .accounts-right::-webkit-scrollbar {
            width: 6px;
        }
        .accounts-right::-webkit-scrollbar-track {
            background: transparent;
        }
        .accounts-right::-webkit-scrollbar-thumb {
            background-color: var(--neutral-400);
            border-radius: 3px;
        }
        .accounts-right::-webkit-scrollbar-thumb:hover {
            background-color: var(--neutral-600);
        }
        .select-all { display: flex; align-items: center; height: 36px; border-bottom: 1px solid #ebeef1; position: relative; }
        .select-all .checkbox-container { width: 22px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: absolute; left: 8px; box-sizing: border-box; margin: 0; padding: 0; }
        .select-all .account-filter-content { display: flex; align-items: center; justify-content: space-between; padding: 8px 6px; margin-left: 30px; flex: 1; box-sizing: border-box; }
        .select-all label { font-size: 14px; font-weight: 400; line-height: 20px; letter-spacing: -0.005em; color: var(--neutral-700); cursor: pointer; }
        .accounts-table { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
                        .accounts-list { 
                    flex: 1; 
                    overflow-y: auto; 
                    min-height: 0;
                    /* Custom scrollbar styling */
                    scrollbar-width: thin; /* Firefox */
                    scrollbar-color: rgba(0, 0, 0, 0.15) transparent; /* Firefox */
                }
                /* Webkit scrollbar styling (Chrome, Safari, Edge) */
                .accounts-list::-webkit-scrollbar {
                    width: 6px;
                }
                .accounts-list::-webkit-scrollbar-track {
                    background: transparent;
                }
                .accounts-list::-webkit-scrollbar-thumb {
                    background: rgba(0, 0, 0, 0.15);
                    border-radius: 3px;
                    transition: background 0.2s ease;
                }
                .accounts-list::-webkit-scrollbar-thumb:hover {
                    background: rgba(0, 0, 0, 0.25);
                }
        .account-item { display: flex; align-items: center; height: 36px; cursor: pointer; position: relative; transition: background-color 0.15s ease; }
        .account-item:hover { background: var(--neutral-25); border-radius: 6px; }
        .checkbox-container { width: 22px; height: 36px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: absolute; left: 8px; box-sizing: border-box; margin: 0; padding: 0; }
        .account-filter-content { display: flex; align-items: center; gap: 6px; padding: 8px 6px; margin-left: 30px; flex: 1; box-sizing: border-box; }
        .account-icon { width: 24px; height: 24px; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .account-name { flex: 1; font-size: 14px; font-weight: 400; line-height: 20px; letter-spacing: -0.005em; color: var(--neutral-700); cursor: pointer; }
        .tree-account { display: flex; align-items: center; height: 28px; padding: 0; }
        .tree-connector { width: 16px; height: 32px; position: relative; flex-shrink: 0; margin-right: 5px; background: #f7f5fd; }
        .tree-connector::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 1px; background: #b6c0cd; }
        .tree-connector::after { content: ''; position: absolute; left: 8px; top: 50%; width: 8px; height: 1px; background: #b6c0cd; transform: translateY(0.5px); }
        .tree-connector.last::before { height: 50%; bottom: auto; left: 8px; }
        .tree-account-name { font-size: 14px; color: #353a44; line-height: 20px; }
        .group-preview { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; height: 32px; }
        .group-preview-icon { color: #6c7688; display: flex; align-items: center; }
        .group-preview-title { font-size: 14px; font-weight: 600; color: #353a44; }
        .step1-button:disabled { background: var(--neutral-200) !important; border-color: var(--neutral-200) !important; color: var(--neutral-400) !important; cursor: not-allowed !important; }
        /* Checkbox styling to match account groups filter */
        input[type="checkbox"] {
            width: 14px;
            height: 14px;
            border: 1px solid var(--neutral-300);
            border-radius: 4px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        input[type="checkbox"]:checked {
            background: var(--brand-600);
            border-color: var(--brand-600);
            position: relative;
        }
        input[type="checkbox"]:checked::after {
            content: '';
            position: absolute;
            left: 4px;
            top: 1px;
            width: 4px;
            height: 7px;
            border: solid white;
            border-width: 0 1px 1px 0;
            transform: rotate(45deg);
        }
        input[type="checkbox"]:indeterminate {
            background: var(--brand-600);
            border-color: var(--brand-600);
            position: relative;
        }
        input[type="checkbox"]:indeterminate::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 2px;
            background: white;
            border-radius: 1px;
        }
    </style>
</head>
<body>
    <div class="preview-container">
        <div class="preview-header">
            <h1>V3 Modal - Static Preview</h1>
            <p>Refactored version using shared Modal component</p>
        </div>
        
        <div class="steps-container">
            <!-- Step 1 -->
            <div class="step-wrapper step-1">
                <div class="step-title">Step 1: Group Details</div>
                <div class="modal-static">
                    <!-- Close button -->
                    <button class="step1-close-button" style="position: absolute; top: 24px; right: 24px; background: none; border: none; cursor: pointer; color: #6c7688; padding: 8px; margin: -8px; z-index: 1000;">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    
                    <!-- Content -->
                    <div class="step1-content" style="padding: 32px 32px 0 32px;">
                        <div class="step1-header" style="margin-bottom: 32px;">
                            <h1 class="step1-title" style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 24px; font-weight: 700; line-height: 32px; color: #21252c; letter-spacing: 0.3px; margin: 0 0 4px 0;">Create an account group</h1>
                            <p class="step1-subtitle" style="font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; font-weight: 400; line-height: 24px; color: #353a44; letter-spacing: -0.31px; margin: 0;">Lorem ipsum dolor</p>
                        </div>
                        <div class="step1-form" style="display: flex; flex-direction: column; gap: 24px;">
                            <div class="step1-field" style="display: flex; flex-direction: column; gap: 6px;">
                                <label class="step1-label" style="font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; font-weight: 600; line-height: 20px; color: #353a44; margin: 0;" for="groupName-static">Group name</label>
                                <input type="text" id="groupName-static" class="step1-input" style="width: 100%; padding: 12px 16px; border: 1px solid #d8dee4; border-radius: 6px; font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; font-weight: 400; line-height: 24px; color: #353a44; background: #ffffff; box-sizing: border-box;" placeholder="Group name" />
                            </div>
                            <div class="step1-field-with-helper" style="display: flex; flex-direction: column; gap: 8px;">
                                <label class="step1-label-optional" style="font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; font-weight: 400; line-height: 20px; color: #353a44; margin: 0;" for="groupDescription-static">Description</label>
                                <textarea id="groupDescription-static" class="step1-textarea" style="width: 100%; padding: 12px 16px; border: 1px solid #d8dee4; border-radius: 6px; font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; font-weight: 400; line-height: 24px; color: #353a44; background: #ffffff; box-sizing: border-box; resize: vertical; min-height: 48px;" placeholder="e.g. Reporting"></textarea>
                                <p class="step1-helper" style="font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 12px; font-weight: 400; line-height: 16px; color: #818da0; margin: 0;">0/150</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="step1-footer" style="display: flex; justify-content: flex-end; padding: 32px; padding-top: 24px; border-top: none;">
                                                    <button id="step1-next-button-static" class="step1-button" disabled style="padding: 8px 16px; border-radius: 6px; font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; font-weight: 600; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #675dff; background: #675dff; color: white;">Next</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2 -->
            <div class="step-wrapper step-2">
                <div class="step-title">Step 2: Select Accounts</div>
                <div class="modal-static">
                    <div class="modal-content" style="padding-bottom: 0 !important;">
                        <div class="custom-modal-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin: -24px -24px 0 -24px; padding: 24px 24px 0 24px; border: none;">
                            <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
                                <button style="display: flex; align-items: center; gap: 6px; background: none; border: none; padding: 0; color: #675dff; font-size: 14px; font-weight: 400; cursor: pointer;">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6.38128 1.38128C6.72299 1.03957 7.27701 1.03957 7.61872 1.38128C7.96043 1.72299 7.96043 2.27701 7.61872 2.61872L3.11244 7.125H15C15.4833 7.125 15.875 7.51675 15.875 8C15.875 8.48325 15.4833 8.875 15 8.875H3.11244L7.61872 13.3813C7.96043 13.723 7.96043 14.277 7.61872 14.6187C7.27701 14.9604 6.72299 14.9604 6.38128 14.6187L0.381282 8.61872C0.210427 8.44786 0.125 8.22393 0.125 8C0.125 7.77607 0.210427 7.55214 0.381282 7.38128L6.38128 1.38128Z" fill="currentColor"/>
                                    </svg>
                                    Back
                                </button>
                                <h2 style="margin: 0; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 24px; font-weight: 700; line-height: 32px; color: #21252c; letter-spacing: 0.3px;">Add accounts</h2>
                                <p style="margin: 0; font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px; font-weight: 400; line-height: 24px; color: #353a44; letter-spacing: -0.31px;">Select accounts from your business to add to this group.</p>
                            </div>
                            <button style="background: none; border: none; padding: 8px; margin: -8px -8px 0 0; cursor: pointer; color: #6c7688;">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="accounts-container">
                            <div class="accounts-left">
                                <div class="search-container" style="position: relative;">
                                    <input type="text" class="modal-form-input" placeholder="Search">
                                </div>
                                <div class="accounts-table" style="margin-top: 24px;">
                                    <div class="select-all">
                                        <div class="checkbox-container">
                                            <input type="checkbox" id="selectAll-static" indeterminate>
                                        </div>
                                        <div class="account-filter-content">
                                            <span style="font-size: 14px; color: #596171;">6 selected</span>
                                        </div>
                                    </div>
                                    <div class="accounts-list">
                                        <div class="account-item" data-account-id="acme-deliveries-ca">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-deliveries-ca" checked>
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon deliveries">AD</div>
                                                <label class="account-name">Acme Deliveries CA</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-deliveries-uk">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-deliveries-uk" checked>
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon deliveries">AD</div>
                                                <label class="account-name">Acme Deliveries UK</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-deliveries-us">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-deliveries-us" checked>
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon deliveries">AD</div>
                                                <label class="account-name">Acme Deliveries US</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-eats-ca">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-eats-ca" checked>
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon eats">AE</div>
                                                <label class="account-name">Acme Eats CA</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-eats-uk">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-eats-uk" checked>
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon eats">AE</div>
                                                <label class="account-name">Acme Eats UK</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-eats-us">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-eats-us" checked>
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon eats">AE</div>
                                                <label class="account-name">Acme Eats US</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-rides-ca">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-rides-ca">
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon rides">AR</div>
                                                <label class="account-name">Acme Rides CA</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-rides-uk">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-rides-uk">
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon rides">AR</div>
                                                <label class="account-name">Acme Rides UK</label>
                                            </div>
                                        </div>
                                        <div class="account-item" data-account-id="acme-rides-us">
                                            <div class="checkbox-container">
                                                <input type="checkbox" id="account-acme-rides-us">
                                            </div>
                                            <div class="account-filter-content">
                                                <div class="account-icon rides">AR</div>
                                                <label class="account-name">Acme Rides US</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="accounts-right">
                                <div class="group-preview">
                                    <div class="group-preview-icon">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16 7.82679C16 7.94141 15.9803 8.05518 15.9417 8.16312L13.974 13.6727C13.6898 14.4687 12.9358 15 12.0906 15H2C0.895431 15 0 14.1046 0 13V3C0 1.89543 0.89543 1 2 1H4.58579C4.851 1 5.10536 1.10536 5.29289 1.29289L6 2H11C12.1046 2 13 2.89543 13 4V5H14C15.1046 5 16 5.89543 16 7V7.82679ZM3.75 6.5C3.33579 6.5 3 6.16421 3 5.75C3 5.33579 3.33579 5 3.75 5H11.5V4C11.5 3.72386 11.2761 3.5 11 3.5H6C5.60218 3.5 5.22064 3.34196 4.93934 3.06066L4.37868 2.5H2C1.72386 2.5 1.5 2.72386 1.5 3V13C1.5 13.2761 1.72386 13.5 2 13.5H12.0906C12.3019 13.5 12.4904 13.3672 12.5614 13.1682L14.5 7.74018V7C14.5 6.72386 14.2761 6.5 14 6.5H3.75Z" fill="var(--neutral-600)"/>
                                        </svg>
                                    </div>
                                    <div class="group-preview-content">
                                        <div class="group-preview-title">North America</div>
                                    </div>
                                </div>
                                <div class="selected-accounts-list" style="margin-top: 4px;">
                                    <div class="tree-account">
                                        <div class="tree-connector"></div>
                                        <div class="tree-account-name">Acme Deliveries CA</div>
                                    </div>
                                    <div class="tree-account">
                                        <div class="tree-connector"></div>
                                        <div class="tree-account-name">Acme Deliveries UK</div>
                                    </div>
                                    <div class="tree-account">
                                        <div class="tree-connector"></div>
                                        <div class="tree-account-name">Acme Deliveries US</div>
                                    </div>
                                    <div class="tree-account">
                                        <div class="tree-connector"></div>
                                        <div class="tree-account-name">Acme Eats CA</div>
                                    </div>
                                    <div class="tree-account">
                                        <div class="tree-connector"></div>
                                        <div class="tree-account-name">Acme Eats UK</div>
                                    </div>
                                    <div class="tree-account">
                                        <div class="tree-connector last"></div>
                                        <div class="tree-account-name">Acme Eats US</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-button modal-button-primary">Done</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Static preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Step 1 character count functionality
            const textareaEl = document.getElementById('groupDescription-static');
            if (textareaEl) {
                const updateCharCount = () => {
                    const helperEl = document.querySelector('.step1-helper');
                    if (helperEl) {
                        const length = textareaEl.value.length;
                        helperEl.textContent = `${length}/150`;
                    }
                };
                textareaEl.addEventListener('input', updateCharCount);
                updateCharCount(); // Initial update
            }

            // Button enable/disable functionality
            const nameField = document.getElementById('groupName-static');
            const nextButton = document.getElementById('step1-next-button-static');
            
            function updateButtonState() {
                if (nameField && nextButton) {
                    const hasName = nameField.value.trim().length > 0;
                    nextButton.disabled = !hasName;
                }
            }
            
            if (nameField && nextButton) {
                updateButtonState(); // Initial check
                nameField.addEventListener('input', updateButtonState);
            }
            
            // Step 2 functionality
            // Get accounts from the current active organization
            function getActiveOrganizationAccounts() {
                if (window.OrgDataManager && window.OrgDataManager.getCurrentOrganization()) {
                    const currentOrg = window.OrgDataManager.getCurrentOrganization();
                    // Filter out the aggregate view account
                    return currentOrg.accounts.filter(account => !account.isAggregate);
                }
                
                // Fallback to mock accounts if no organization is loaded
                return [
                    { id: 'acme-deliveries-ca', name: 'Acme Deliveries CA', type: 'deliveries' },
                    { id: 'acme-deliveries-uk', name: 'Acme Deliveries UK', type: 'deliveries' },
                    { id: 'acme-deliveries-us', name: 'Acme Deliveries US', type: 'deliveries' },
                    { id: 'acme-eats-ca', name: 'Acme Eats CA', type: 'eats' },
                    { id: 'acme-eats-uk', name: 'Acme Eats UK', type: 'eats' },
                    { id: 'acme-eats-us', name: 'Acme Eats US', type: 'eats' },
                    { id: 'acme-rides-ca', name: 'Acme Rides CA', type: 'rides' },
                    { id: 'acme-rides-uk', name: 'Acme Rides UK', type: 'rides' },
                    { id: 'acme-rides-us', name: 'Acme Rides US', type: 'rides' }
                ];
            }
            
            const accounts = getActiveOrganizationAccounts();
            
            let selectedAccounts = new Set(['acme-deliveries-ca', 'acme-deliveries-uk', 'acme-deliveries-us', 'acme-eats-ca', 'acme-eats-uk', 'acme-eats-us']);
            
            // Search functionality
            const searchInput = document.querySelector('.step-2 input[placeholder="Search"]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    renderAccountsWithSearch();
                });
            }
            
            // Select all functionality
            const selectAllCheckbox = document.querySelector('.step-2 .select-all input[type="checkbox"]');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', () => {
                    toggleSelectAll();
                });
            }
            
            // Make select all row clickable
            const selectAllRow = document.querySelector('.step-2 .select-all');
            if (selectAllRow) {
                selectAllRow.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') {
                        return;
                    }
                    
                    const checkbox = selectAllRow.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                });
            }
            
            // Account row functionality
            const accountItems = document.querySelectorAll('.step-2 .account-item');
            accountItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const accountId = item.getAttribute('data-account-id') || checkbox?.id?.replace('account-', '');
                
                // Set initial state
                if (accountId && selectedAccounts.has(accountId)) {
                    checkbox.checked = true;
                }
                
                // Make row clickable
                item.addEventListener('click', (e) => {
                    if (e.target.type === 'checkbox') {
                        return;
                    }
                    
                    checkbox.checked = !checkbox.checked;
                    
                    // Call toggleAccount directly with the correct accountId
                    if (accountId) {
                        toggleAccount(accountId);
                    }
                });
                
                // Handle checkbox changes
                checkbox.addEventListener('change', () => {
                    toggleAccount(accountId);
                });
            });
            
            function renderAccountsWithSearch() {
                const searchInput = document.querySelector('.step-2 input[placeholder="Search"]');
                const searchTerm = searchInput?.value?.toLowerCase() || '';
                
                const filteredAccounts = accounts.filter(account => 
                    !searchTerm || account.name.toLowerCase().includes(searchTerm)
                );
                
                const accountsContainer = document.querySelector('.step-2 .accounts-list');
                accountsContainer.innerHTML = filteredAccounts.map(account => `
                    <div class="account-item" data-account-id="${account.id}">
                        <div class="checkbox-container">
                            <input type="checkbox" id="account-${account.id}" ${selectedAccounts.has(account.id) ? 'checked' : ''}>
                        </div>
                        <div class="account-filter-content">
                            <div class="account-icon" style="background-color: ${account.color || '#3B82F6'}">${account.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2)}</div>
                            <label class="account-name">${account.name}</label>
                        </div>
                    </div>
                `).join('');
                
                // Re-bind events for new elements
                bindAccountEvents();
                updateSelectionCount();
                updateSelectAllState();
                updatePreview();
            }
            
            function bindAccountEvents() {
                const accountItems = document.querySelectorAll('.step-2 .account-item');
                accountItems.forEach(item => {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const accountId = item.getAttribute('data-account-id') || checkbox?.id?.replace('account-', '');
                    
                    // Remove existing listeners by cloning
                    const newItem = item.cloneNode(true);
                    item.parentNode.replaceChild(newItem, item);
                    const newCheckbox = newItem.querySelector('input[type="checkbox"]');
                    
                    // Make row clickable
                    newItem.addEventListener('click', (e) => {
                        if (e.target.type === 'checkbox') {
                            return;
                        }
                        
                        newCheckbox.checked = !newCheckbox.checked;
                        
                        // Call toggleAccount directly with the correct accountId
                        if (accountId) {
                            toggleAccount(accountId);
                        }
                    });
                    
                    // Handle checkbox changes
                    newCheckbox.addEventListener('change', () => {
                        toggleAccount(accountId);
                    });
                });
            }

            function toggleAccount(accountId) {
                if (selectedAccounts.has(accountId)) {
                    selectedAccounts.delete(accountId);
                } else {
                    selectedAccounts.add(accountId);
                }
                updateSelectionCount();
                updateSelectAllState();
                updatePreview();
            }
            
            function toggleSelectAll() {
                const selectAllCheckbox = document.querySelector('.step-2 .select-all input[type="checkbox"]');
                const isChecked = selectAllCheckbox?.checked || false;
                
                // Get currently visible accounts (filtered)
                const searchInput = document.querySelector('.step-2 input[placeholder="Search"]');
                const searchTerm = searchInput?.value?.toLowerCase() || '';
                const visibleAccounts = accounts.filter(account => 
                    !searchTerm || account.name.toLowerCase().includes(searchTerm)
                );
                
                // Apply to ONLY visible accounts
                visibleAccounts.forEach(account => {
                    const checkbox = document.querySelector(`#account-${account.id}`);
                    if (checkbox) {
                        checkbox.checked = isChecked;
                    }
                    
                    if (isChecked) {
                        selectedAccounts.add(account.id);
                    } else {
                        selectedAccounts.delete(account.id);
                    }
                });
                
                updateSelectionCount();
                updateSelectAllState();
                updatePreview();
            }
            
            function updateSelectionCount() {
                const countEl = document.querySelector('.step-2 .select-all .account-filter-content span');
                if (countEl) {
                    countEl.textContent = `${selectedAccounts.size} selected`;
                }
            }
            
            function updateSelectAllState() {
                const selectAllCheckbox = document.querySelector('.step-2 .select-all input[type="checkbox"]');
                if (!selectAllCheckbox) return;
                
                // Get currently visible accounts (filtered)
                const searchInput = document.querySelector('.step-2 input[placeholder="Search"]');
                const searchTerm = searchInput?.value?.toLowerCase() || '';
                const visibleAccounts = accounts.filter(account => 
                    !searchTerm || account.name.toLowerCase().includes(searchTerm)
                );
                
                // Count how many visible accounts are selected
                const selectedVisibleCount = visibleAccounts.filter(account => 
                    selectedAccounts.has(account.id)
                ).length;
                
                const totalVisibleAccounts = visibleAccounts.length;
                const totalSelectedAccounts = selectedAccounts.size;
                
                // Check if there are selected accounts outside the visible list
                const visibleAccountIds = new Set(visibleAccounts.map(account => account.id));
                const selectedNotVisible = Array.from(selectedAccounts).some(accountId => 
                    !visibleAccountIds.has(accountId)
                );
                
                // Simple rules:
                if (totalSelectedAccounts === 0) {
                    // No accounts selected anywhere
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedVisibleCount === totalVisibleAccounts) {
                    // All visible accounts are selected
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    // Some accounts selected but not all visible ones
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
            
            function filterAccountsBySearch(searchTerm) {
                const accountItems = document.querySelectorAll('.step-2 .account-item');
                
                accountItems.forEach(item => {
                    const label = item.querySelector('.account-name');
                    if (label) {
                        const accountName = label.textContent.toLowerCase();
                        const shouldShow = !searchTerm || accountName.includes(searchTerm.toLowerCase());
                        item.style.display = shouldShow ? 'flex' : 'none';
                    }
                });
                
                updateSelectionCount();
                updateSelectAllState();
            }
            
            function updatePreview() {
                const selectedAccountsList = document.querySelector('.step-2 .selected-accounts-list');
                const selected = accounts.filter(account => selectedAccounts.has(account.id));
                
                if (selected.length === 0) {
                    selectedAccountsList.innerHTML = '<div style="color: #6c7688; font-size: 12px; font-style: italic; margin-top: 4px;">No accounts selected</div>';
                } else {
                    selectedAccountsList.innerHTML = selected.map((account, index) => `
                        <div class="tree-account">
                            <div class="tree-connector ${index === selected.length - 1 ? 'last' : ''}"></div>
                            <div class="account-icon" style="background-color: ${account.color || '#3B82F6'}; width: 16px; height: 16px; font-size: 8px; margin-right: 8px;">${account.name.split(' ').map(word => word[0]).join('').toUpperCase().slice(0, 2)}</div>
                            <div class="tree-account-name">${account.name}</div>
                        </div>
                    `).join('');
                }
            }
            
            // Initialize
            updateSelectionCount();
            updateSelectAllState();
            updatePreview();
        });
    </script>
</body>
</html>